<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Taco Transport</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map'></div>
<script>

L.mapbox.accessToken = 'pk.eyJ1IjoiaWFuamVubmluZ3MiLCJhIjoiZExwb0p5WSJ9.XLi48h-NOyJOCJuu1-h-Jg';
var map = L.mapbox.map('map', 'ianjennings.l896mh2e');

var plotter = function (map) {

  var self = this;

  self.markers = [];

  self.refreshRate = 10;

  self.map = map;
  self.lastUpdate = new Date().getTime();

  self.update = function (seed, animate) {

    var i = 0;
    while(i < seed.length) {

      if(typeof self.markers[i] == 'undefined') {


        self.markers[i] = L.marker(seed[i].latlng);
        self.markers[i].addTo(self.map);

      } else {

        if(self.markers[i].lat !== seed[i].latlng[0] ||
           self.markers[i].getLatLng().lng !== seed[i].latlng[1]) {

          if(animate) {
            self.animate(i, seed[i].latlng);
          } else {
            self.updateMarker(i, seed[i].latlng);
          }

        }

      }

      if(typeof seed[i].options !== 'undefined') {
        for(j in seed[i].options) {

          if(j == 'icon') {
            self.markers[i].setIcon(L.mapbox.marker.icon(seed[i].options[j]));
          }

        }
      }

      i++;

    }

    self.lastUpdate = new Date().getTime();

  };

  self.updateMarker = function (index, point) {
    self.markers[index].setLatLng(point);
  };

  self.animations = {};
  self.animate = function (index, destination) {

    self.animations[index] = {
      start: self.markers[index].getLatLng(),
      dest: destination,
      time: new Date().getTime(),
      length: new Date().getTime() - self.lastUpdate
    };

  };

  self.refresh = function() {

    var index = 0;
    while(index < self.markers.length) {

      if(typeof self.animations[index] !== 'undefined') {

        // number of steps in this animations
        var maxSteps = Math.round(self.animations[index].length / self.refreshRate)

        // time that has passed since that message
        var timeSince = new Date().getTime() - self.animations[index].time;
        var numSteps = Math.round(timeSince / self.refreshRate)

        var position = self.animations[index].start;

        var lat = position.lat + ((self.animations[index].dest[0] - position.lat) / maxSteps) * numSteps;
        var lng = position.lng + ((self.animations[index].dest[1] - position.lng) / maxSteps) * numSteps;

        var nextStep = [lat, lng];

        if(index == 0) {

          console.log(maxSteps, timeSince, numSteps, nextStep)
        }

        self.updateMarker(index, nextStep);

      }

      index++;

    };


  };

  self.refresh();
  setInterval(self.refresh, self.refreshRate);

};

function getNonZeroRandomNumber(){
  var random = Math.floor(Math.random()*199) - 99;
  if(random==0) return getNonZeroRandomNumber();
  return random;
}

var me = {
  icon: {
    'marker-color': '#ce1126'
  }
};
var them = {
  icon: {
    'marker-color': '#29abe2'
  }
};

var torchys = [
  {
    latlng: [30.370375, -97.756138],
    options: them
  },
  {
    latlng: [30.323118, -97.739144],
    options: them
  },
  {
    latlng: [30.302816, -97.699490],
    options: them
  },
  {
    latlng: [30.293479, -97.742405],
    options: me
  },
  {
    latlng: [30.250337, -97.754593],
    options: them
  },
  {
    latlng: [30.236689, -97.762730],
    options: them
  }
];

var tacos = new plotter(map);

tacos.update(torchys);

setInterval(function(){

  var new_torchys = JSON.parse(JSON.stringify(torchys));
  for (var i = 0; i < new_torchys.length; i++) {

    new_torchys[i] = {
      latlng: [
        new_torchys[i].latlng[0] + (getNonZeroRandomNumber() * 0.0002),
        new_torchys[i].latlng[1] + (getNonZeroRandomNumber() * 0.0002)
      ]
    }

  }

  tacos.update(new_torchys, true);
  map.setView(new_torchys[3].latlng, 13);


}, 1000);

</script>
</body>
</html>